name: Smart variable daily commits

on:
  schedule:
    - cron: '0 12 * * *'  
  workflow_dispatch:

permissions:
  contents: write

env:
  REPO: ${{ github.repository }}       
  TARGET_BRANCH: main
  GIT_NAME: "0xdya"
  GIT_EMAIL: "0xdya@proton.me"
  FIREBASE_URL: "https://oxdyaa-default-rtdb.firebaseio.com/visits.json"
  ALWAYS_COMMIT: "true"

jobs:
  smart-commits:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TARGET_BRANCH }}

      - name: Determine commit count based on weekday
        id: decide
        run: |
          DOW=$(date -u +%u)
          echo "weekday=$DOW" >> $GITHUB_OUTPUT

          if [ "$DOW" -ge 1 ] && [ "$DOW" -le 4 ]; then
            MIN=2; MAX=6
          elif [ "$DOW" -eq 5 ]; then
            MIN=1; MAX=5
          else
            MIN=6; MAX=14
          fi

          RAND_COUNT=$(( (RANDOM % (MAX - MIN + 1)) + MIN ))

          SPIKE_CHANCE=$((RANDOM % 100))
          if [ "$SPIKE_CHANCE" -lt 10 ]; then
            MULT=$(( (RANDOM % 6) + 15 ))   # 15..20 => 1.5..2.0 عند قسمة على 10
            RAND_COUNT=$(( (RAND_COUNT * MULT) / 10 ))
            echo "spike=true" >> $GITHUB_OUTPUT
          else
            echo "spike=false" >> $GITHUB_OUTPUT
          fi

          if [ "$RAND_COUNT" -lt 1 ]; then
            RAND_COUNT=1
          fi

          echo "count=$RAND_COUNT" >> $GITHUB_OUTPUT
          echo "Computed commit count: $RAND_COUNT (DOW=$DOW, MIN=$MIN, MAX=$MAX)"

      - name: Make commits (variable number)
        env:
          GIT_AUTHOR_NAME: ${{ env.GIT_NAME }}
          GIT_AUTHOR_EMAIL: ${{ env.GIT_EMAIL }}
          GIT_COMMITTER_NAME: ${{ env.GIT_NAME }}
          GIT_COMMITTER_EMAIL: ${{ env.GIT_EMAIL }}
          FIREBASE_URL: ${{ env.FIREBASE_URL }}
          ALWAYS_COMMIT: ${{ env.ALWAYS_COMMIT }}
        run: |
          git config user.name "$GIT_AUTHOR_NAME"
          git config user.email "$GIT_AUTHOR_EMAIL"

          COUNT=${{ steps.decide.outputs.count }}
          for i in $(seq 1 $COUNT); do
            VISITS_RAW=$(curl -s "$FIREBASE_URL" || echo "0")
            VISITS=$(echo "$VISITS_RAW" | tr -d '"')

            DATE=$(date -u +'%Y-%m-%d %H:%M:%S UTC')

            # تحديث archive و README
            echo "$DATE - $VISITS" >> archive.txt

            if grep -q "^Total visits today:" README.md; then
              sed -i "s/^Total visits today:.*/Total visits today: $VISITS (as of $DATE)/" README.md || true
            else
              echo "" >> README.md
              echo "Total visits today: $VISITS (as of $DATE)" >> README.md
            fi

            git add archive.txt README.md || true

            if [ "$ALWAYS_COMMIT" = "true" ]; then
              git commit --allow-empty -m "Auto update ($i/$COUNT): visits=$VISITS at $DATE" || true
            else
              git commit -m "Auto update ($i/$COUNT): visits=$VISITS at $DATE" || echo "No changes to commit"
            fi

            SLEEP_SEC=$((RANDOM % 21 + 5))
            sleep $SLEEP_SEC
          done

      - name: Push commits
        env:
          PERSONAL_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          git push https://x-access-token:${PERSONAL_TOKEN}@github.com/${{ env.REPO }}.git ${{ env.TARGET_BRANCH }}
